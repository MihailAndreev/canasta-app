# Валидация на wild карти в мръсна комбинация (mixed meld / mixed canasta)

Този документ представлява **пълна, формална и изчерпателна спецификация** за валидиране на wild карти (жокери и двойки) **в ролята им на заместител на natural карти**, когато участват в **мръсна комбинация / мръсна канаста**.

Документът е предназначен за:

- игрова логика (engine);
- UI валидиране (drag & drop, preview, warnings);
- тестове;
- бъдеща поддръжка на правилата.

---

## 1. Термини и нотация

### 1.1 Видове карти

- **Natural (N)** – всяка карта, която **не е** wild (A, K, Q, J, 10, 9, …, 4).
- **Wild (W)** – карта, която замества natural:
  - Жокер
  - Двойка (2)

### 1.2 Нотация в примерите

Комбинациите се изписват абстрактно, без боя и ранг:

- `N` – natural карта
- `W` – wild карта

Пример:

```
N N N W W N N
```

означава 7-картова комбинация с 3 natural, 2 wild, 2 natural.

---

## 2. Базови количествени ограничения

### 2.1 Максимален брой wild карти

- В един meld / canasta могат да участват **най-много 3 wild карти**.

### 2.2 Размер на мръсна канаста

- Мръсна канаста съдържа **точно 7 карти**.
- От тях **минимум 4 трябва да са natural**.

Следствие:

- допустими са точно 1, 2 или 3 wild карти;
- 4 или повече wild карти правят комбинацията невалидна.

---

## 3. Забрани за начало на комбинацията

### 3.1 Забрана за начало с wild

- Мръсна комбинация **никога не може да започне с wild карта**.

❌ Невалидни:

```
W N N N N N N
W W N N N N N
```

---

## 4. Минимум natural преди първата wild карта

### 4.1 Основно изискване

- Преди **първата** wild карта трябва да има **минимум 2 последователни natural карти**.

❌ Невалидно:

```
N W N N N N N   (само 1 natural преди W)
```

✅ Валидно:

```
N N W N N N N
```

---

## 5. Авторитетно правило за последователни wild карти

### 5.1 Формулировка

**Правило:**

> Броят на последователните wild карти трябва винаги да е **строго по-малък** от броя на **непосредствено предхождащите ги natural карти**.

Формално:

```
count(consecutive W) < count(immediately preceding N)
```

---

## 6. Как се броят „непосредствено предхождащите natural“

За всяка поредица от wild карти:

- броенето на natural започва:
  - от началото на комбинацията, **или**
  - след предходна wild карта;
- броят се **само natural карти, които са точно преди тази поредица**;
- natural карта **прекъсва** wild-поредица, но **не рестартира** комбинацията.

Всяка поредица от wild карти се валидира **самостоятелно**.

### Пример: броене на „непосредствено предхождащите natural“

    N N N W W N W N

- **Първа поредица от wild:** `W W`  
  - Непосредствено предхождащи natural: `N N N` → 3  
  - Проверка: `2 < 3` → ✅ валидно  

- **Втора поредица от wild:** `W`  
  - Броенето на natural започва **след предходната wild карта**  
  - Непосредствено предхождащи natural: `N` → 1  
  - Проверка: `1 < 1` → ❌ невалидно  

➡️ **Цялата комбинация е невалидна**, въпреки че първата поредица от wild е валидна.


---

## 7. Позиционни ограничения

### 7.1 Не първа комбинация на отбора

- Wild карти могат да се намират **само на позиции от 3 до 7**.

### 7.2 Първа комбинация на отбора (opening meld – изключение)

- Комбинацията трябва да започва с **минимум 3 последователни natural карти**.
- Wild карти са позволени **само от позиции от 4 до 7**.
- Wild карта **не може** да бъде на 3-та позиция.

---

## 8. Изчерпателен списък на валидните позиции на wild карти

Всички примери по-долу са за **7 карти**.

### 8.1 С 1 wild карта

```
N N W N N N N -> само за не-първа комбинация на отбора
N N N W N N N
N N N N W N N
N N N N N W N
N N N N N N W
```

### 8.2 С 2 wild карти

#### Валидни конфигурации

```
N N W N N W N -> само за не-първа комбинация на отбора
N N W N N N W -> само за не-първа комбинация на отбора
N N N W W N N
N N N N W W N
N N N N N W W
```

#### Невалидни (примерни грешки)

```
N N N W N W N   ❌ (втора W има само 1 предхождащ N)
N N N N W N W   ❌
```

### 8.3 С 3 wild карти

#### Валидни конфигурации

```
N N N N W W W ✅
```
#### Невалидни (примерни грешки)
```
N N N W W W N ❌
```
Обяснение:
- преди `W W W` има поне 3 последователни natural;
- 3 < 3 ❌ не е позволено → затова първият валиден вариант изисква **4 natural преди W W W**:



## 9. Обобщена таблица за бърза валидация

| Проверка         | Условие           |
| ---------------- | ----------------- |
| Начало           | първата карта ≠ W |
| Начало           | втора карта ≠ W   |
| Wild общо        | ≤ 3               |
| Natural общо     | ≥ 4               |
| Преди първи W    | ≥ 2 N             |
| Последователни W | W < предхождащи непрекъснати N |
| Opening meld     | ≥ 3 N в началото  |

---

## 10. Заключение

Тези правила:

- елиминират двусмислие;
- позволяват **детерминистична машинна валидация**;
- покриват всички edge-case сценарии;
- са съвместими с официалния правилник на проекта.

Този документ е **авторитетен източник** за логиката на wild карти в мръсни комбинации и трябва да се използва директно при имплементация и тестове.
